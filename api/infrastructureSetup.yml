name: ðŸ—ï¸ Setup Infrastructure

on:
  workflow_dispatch:

env:
  PROJECT_ID: project-sauter-hydro-forecast
  GAR_LOCATION: us-central1

jobs:
  setup:
    name: ðŸ—ï¸ Configurar Infraestrutura
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ðŸ” Autenticar no GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: â˜ï¸ Configurar gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ“¦ Criar repositÃ³rio no Artifact Registry
        run: |
          # Verificar se o repositÃ³rio jÃ¡ existe
          if ! gcloud artifacts repositories describe sauter-repo --location=$GAR_LOCATION --project=$PROJECT_ID >/dev/null 2>&1; then
            echo "ðŸ—ï¸ Criando repositÃ³rio sauter-repo..."
            gcloud artifacts repositories create sauter-repo \
              --repository-format=docker \
              --location=$GAR_LOCATION \
              --description="RepositÃ³rio Docker para API Sauter" \
              --project=$PROJECT_ID
            echo "âœ… RepositÃ³rio criado com sucesso!"
          else
            echo "â„¹ï¸ RepositÃ³rio sauter-repo jÃ¡ existe"
          fi

      - name: ðŸ”§ Habilitar APIs necessÃ¡rias
        run: |
          gcloud services enable run.googleapis.com
          gcloud services enable artifactregistry.googleapis.com
          gcloud services enable cloudbuild.googleapis.com
          echo "âœ… APIs habilitadas"

      - name: ðŸ“ Resumo
        run: |
          echo "## ðŸ—ï¸ ConfiguraÃ§Ã£o da Infraestrutura ConcluÃ­da" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… RepositÃ³rio Docker: $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/sauter-repo" >> $GITHUB_STEP_SUMMARY
          echo "âœ… APIs necessÃ¡rias habilitadas" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pronto para deploy!" >> $GITHUB_STEP_SUMMARY